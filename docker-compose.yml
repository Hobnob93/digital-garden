version: "3.9"

services:
  web:
    image: ghcr.io/Hobnob93/digital-garden:latest
    restart: unless-stopped
    environment:
      ASPNETCORE_ENVIRONMENT: Production
      ASPNETCORE_URLS: http://0.0.0.0:8080
      # Serilog -> Seq (ingestion endpoint is 5341)
      SERILOG__WRITETO__0__NAME: Seq
      SERILOG__WRITETO__0__ARGS__SERVERURL: http://seq:5341
      SERILOG__WRITETO__0__ARGS__APIKEY: ${SEQ_API_KEY:-}
    labels:
      traefik.enable: "true"
      traefik.docker.network: root_default
      traefik.http.routers.garden.rule: Host(`${GARDEN_DOMAIN}`,`www.${GARDEN_DOMAIN}`)
      traefik.http.routers.garden.entrypoints: websecure
      traefik.http.routers.garden.tls: "true"
      traefik.http.routers.garden.tls.certresolver: mytlschallenge
      traefik.http.middlewares.garden-www2apex.redirectregex.regex: ^https?://www\.${GARDEN_DOMAIN}/(.*)
      traefik.http.middlewares.garden-www2apex.redirectregex.replacement: https://${GARDEN_DOMAIN}/$1
      traefik.http.routers.garden.middlewares: garden-www2apex@docker
      traefik.http.services.garden.loadbalancer.server.port: "8080"
    networks: [traefik]

  seq:
    image: datalust/seq:latest
    restart: unless-stopped
    environment:
      ACCEPT_EULA: "Y"
    volumes:
      - seq-data:/data
    labels:
      traefik.enable: "true"
      traefik.docker.network: root_default
      traefik.http.routers.seq.rule: Host(`logs.${GARDEN_DOMAIN}`)
      traefik.http.routers.seq.entrypoints: websecure
      traefik.http.routers.seq.tls: "true"
      traefik.http.routers.seq.tls.certresolver: mytlschallenge
      traefik.http.services.seq.loadbalancer.server.port: "80"   # Seq UI at port 80
      traefik.http.middlewares.seq-auth.basicauth.users: ${SEQ_BASIC_AUTH}
      traefik.http.middlewares.seq-ips.ipwhitelist.sourcerange: ${ADMIN_IPS:-0.0.0.0/0}
      traefik.http.routers.seq.middlewares: seq-auth@docker,seq-ips@docker
    networks: [traefik]

volumes:
  seq-data:

networks:
  traefik:
    external: true
    name: root_default
